# 支付系统核心能力服务

## 扫码支付

1. 根据浏览器类型判断用户支付方式
2. 从缓存中获取参数**（生成二维码时插入缓存，有效期5分钟）**
3. 根据支付方式路由支付渠道（PS: 同一种支付方式可能存在多种支付渠道， 渠道费率不同）
4. 校验是否需要三方授权
   1. 如果需要三方授权，则重定向到三方授权
5. 验证订单是否重复支付
   1. 根据请求流水号从缓存获取订单明细列表**（收单时会插入redis）**
   2. 遍历订单列表， 根据订单号查询redis缓存中支付成功记录**（支付成功后插入缓存）**，若存在提示用户该笔订单已支付完成
6. 渠道支付请求数缓存自增1**（目的是为了渠道健康检查，支付成功数/支付请求数。 支付成功数在支付成功时会插入缓存）**
7. 计算还需支付金额
   1. 查询余额（PS:只有资产类支付渠道才能查询余额）
   2. 查询收单时记录的应付金额
   3. 查询已经预支付的金额总和
   4. 还需支付金额 = 应付金额-已预支付金额
8. 请求三方渠道统一下单（这步也可以理解为支付）
9. 插入支付表PP_PAY
10. 进行防调单监控处理
11. 发送支付消息到kafka. 由看板系统监听
12. 将响应结果响应给前端， 前端JS拉起第三方收银台

## 防调单处理

1. 判断该网关是否需要防调单
   1. 从缓存中获取不需要防调单的网关列表**（手动配置插入到redis缓存）**， 如果包含当前网关直接结束
2. 处理防调单处理频率
   1. 从缓存中获取**（手动配置插入到redis缓存）**
      1. 若缓存存在， 则以缓存中频率间隔为准， 否则以本地为准（默认为90s, 10s, 30s, 60s）
3. 创建延迟任务线程池异步处理防调单
4. 根据reqNo请求流水号查询通知消息缓存中是否存在（支付订单系统及勾兑系统时插入缓存中）， 如果存在的话说明已经成功，无需再防调单结束
5. 调用三方系统查询支付状态
6. 如果支付失败， 则继续下一次间隔时间轮训调用三方系统查询支付状态（继续防调单处理），直至执行次数>=间隔时间个数时结束不再继续轮训。
7. 更新支付状态， 及做了预支付的流水做完支付**（同三方异步通知逻辑）**



## 三方异步结果通知

1.aaavvv

