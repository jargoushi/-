我是在哪个公司主要从事的是支付系统的开发与维护。主要是为外围的不同商户（业务线）提供收单，收银台，支付，退款，查询，防调单，通知，监控等服务。 我们系统是采用微服务架构，拆为收单模块（order）,支付模块（payment）,网关（gateway）,网关回调（gateway-callback）,监控（monitor），查询（query），mpay(h5web),cashierweb（pc web）模块。

使用到的框架包括： springboot, dubbo,kafka,redis,定时任务(cotrob),mybatis.使用的数据库是mysql



当有新的商户接入支付平台时需要运营人员在后台管理进行商户的配置（商户的签名码，商户支持的支付方式，收银台展示是否需要用户登录等）



当用户在订单确认页点击提交订单按钮时订单系统调用收单服务进行收单（下单，记录订单信息）。为了保障数据在传输过程中不被篡改，订单系统需要对收单参数进行签名（根据商户的签名码），收单系统需要对其进行验证。

记录订单信息，支付超时时间，商家支持的支付方式（不同的商家支持的支付方式不同）等



收单成功之后展示收银台页面，如果商户配置需要登录才能展示收银台但是未登录会跳转到登录页面，登录成功后重定向会收银台，主要展示订单信息，要展示的支付方式（商户支持的支付方式与商家支持的支付方式的交集，用户习惯使用的支付方式（PS: 用户订单支付完成后添加到缓存，如果缓存不存在推荐一种支付方式）），用户的资产信息（用户登录才会查询资产（内部渠道的余额），如果余额为0过滤该渠道支付方式），

支付平台接入的渠道主要有聚合扫码支付（主扫，被扫），资产（账户余额，邮乐卡，邮储积分，邮政积分，红包雨），快捷支付，网银支付



当用户点击扫码支付的时候，

- 首先会生成一个聚合二维码，很多客户端都可以扫码（其实就是个访问地址url，会将该二维码插入到缓存中，因为需要设置二维码的过期时间为5分钟）
- 根据请求浏览器类型校验支付方式（支付宝或者是微信）
- 校验二维码是否过期
- 根据支付方式路由支付渠道（后端管理系统配置）
- 校验是否需要授权（微信判断openid是否存在，支付宝判断auth_code是否存在）
  - 如果已授权继续支付，未授权跳转三方授权，授权完成后继续跳转支付
- 校验支付是否已支付完成（支付成功后会将成功标记插入到缓存reqNo）,已完成提示用户，否则继续支付
- 因为存在组合支付的情况，所以需要计算还需支付金额
  - 查询收单记录的应付金额，查询已预支付（支付已经冻结的流水）金额，查询余额（只有资产类才能查询余额）。还需支付金额= 应付金额-预支付金额。。 与余额取小（为了支持组合支付， 比如： 用户应付10元，用资产支付时，余额为5元，先冻结资产5元。剩余5元由其他支付方式支付）
- 请求三方进行预支付
- 记录支付流水
- 防调单（主动监控查询支付状态）









快捷支付

1.校验用户是否已绑定卡，如果未绑定卡跳转到绑卡页面

2.如果以绑卡，校验是否绑定多张，如果是多张跳转到选择银行卡页面，选择完卡之后进行支付

3.如果绑定一张卡，直接进行支付



网银支付

1.筛选渠道，组装参数， 根据三方响应报文组装form表单跳转



总结： 扫码支付，快捷支付，网银支付非公司内部渠道支付完成之后需要校验返回PREPAY或者是PAY（不需要）

资产类支付完成之后需要校验返回PREPAY或者是PAY(需要)， 可能存在部分支付



组合支付



应付100块， 余额付20块（冻结），红包雨30（冻结），微信（50块）

1笔支付请求对应三笔组合支付， 微信支付成功之后（1.防调单成功 2. 异步通知成功）将之前做了预支付还没有支付的流水支付掉

微信扣50块成功，余额扣20块成功，红包雨扣30失败