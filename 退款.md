# 系统退款与用户退款区别

|                  | 系统退款                            | 用户退款                                         |
| ---------------- | ----------------------------------- | ------------------------------------------------ |
| 触发机制         | 超额支付，已取消支付， 运营后台处理 | 用户在商户系统页面操作                           |
| 是否需要拆分     | 不需要                              | 需要（组合支付，退款需要由商户系统告诉退款规则） |
| 是否支持部分退款 | 不支持（比如微信退款5元，只能全退） | 支持（比如微信支付5元，可以退多次）              |



# 系统退款

## 什么是系统退款

非用户操作的退款（超额支付，取消支付, 运营人员后台管理操作）

## 系统退款流程

1. 系统退款申请(只是进行退款请求记录，实际并不会发生退款)
2. 定时任务扫描进行批量系统退款

## 系统退款申请

1. 重复性验证，不允许重复退款（系统退款不允许部分退款，比如组合支付了两笔， 其中微信5元，余额5元。 系统退款微信只能退5元，不能退2元）
2. 找到支付流水，必须原支付流水支付成功才可以退款
3. 记录系统退款请求(sys_refund)，记录退款流水(pp_Pay), 状态此时都为**new新建**

**一笔退款流水对应一笔支付流水**

## 定时处理批量系统退款（20分钟执行1次）

1. 扫描出所有需要执行系统退款的流水(表：系统退款表SYS_REFUND, 条件：新建)
2. 更新退款流水表与系统退款表状态为处理中， 防止本次退款未执行完下次退款又扫描到
3. 调用三方渠道进行退款
4. 更新退款请求表与退款流水表状态为三方响应状态



# 用户退款

## 什么是用户退款

由用户作为发起人触发的退款

## 用户退款流程

商户系统发起退款申请后，支付平台会实时进行退款（排除部分渠道不支持当前时间退的）

1. 验证
   1. 重复性验证，分布式锁（只是验证退款请求，但是并不验证退款规则流水，因为可以重复退款）
   2. 签名验证
   3. 金额验证（要退款的支付流水的金额）
      1. 查询要退款的流水的已支付金额， 查询要退款的流水的已退款金额。 已支付金额 - 已退款金额是否大于要退的金额。 **如果要退多笔则每笔都需要验证**
2. 记录退款请求（pp_pay_refund_request）, 状态为new新建
3. 按照退款规则**（json数组， 包含了要退款的支付流水号， 和金额）**进行拆分为PP_PAY_REFUND_TASK
   1. 遍历退款规则， 根据每个规则的支付流水号查询已支付的金额
   2. 查询已退款金额（pp_pay_refund_task）
   3. 已支付金额-已退款金额， 与退款规则中要退的金额取小。   本次退款要退的金额
   4. 生成退款任务流水（pp_pay_refund_task）， 状态为**new状态**
4. 更新退款请求PP_pAY_REFUND_REQEUST状态为处理中
5. 移除当前时间渠道不支持退款的任务， 
6. 当前可退的任务状态为处理中， 防止定时扫描到
7. 如果pp_pay_refund_task是第一次退生成pp_pay退款流水
8. 请求三方渠道进行退款
9. 更新pp_pay退款流水，pp_pay_refund_task退款任务状态为渠道响应状态（**可能为成功， 退款异常，** **无效（退款次数超过3仍然失败，由运营介入）**）
10. 如果存在未退款成功的任务，则结束
11. 否则更新pp_pay_refund_request退款请求记录为成功
12. kafka通知勾兑，通知商户系统
13. 大额退款发送短信



## 定时退款（30分钟一次）

用户退款时渠道不支持当前退怎么办？ 状态为new

如果调用三方渠道退款失败了怎么办？状态为**退款异常**， **无效状态只能运营介入**

1. 扫描所有状态为新建， 退款异常的**退款任务pp_pay_refund_task**。
2. 将**退款任务pp_pay_refund_task**改为处理中，防止下次定时扫描
3. 此时就不需要再次拆分了



# 退款举例

比如： 用户收单需要支付10元， 用户选择余额支付了5元， 微信支付了5元。

此时PP_PAY_REQUEST状态为成功, 两条PP_PAY状态为成功，类型为支付(支付流水号分别为:123456, 654321)



商户系统请求支付系统为用户退款， 退款规则:[{"payId":"123456", "amount":"2"}, {"payId": "654321", "amount": "5"}]

说明现在要余额退款2元， 微信退款5元

记录退款请求PP_PAY_REFUND_REQUEST， 总退款记录为7元，退款状态为新建



按照退款规则进行拆分之后为两条PP_PAY_REFUND_TASK, 状态都为新建， 金额分别为余额退2，微信退5

如果当前时间余额支持退款，微信不支持退款。 把余额对应的PP_PAY_REFUND_TASK状态改为处理中， 退款请求PP_PAY_REFUND_REQUEST状态为处理中

因为只有余额支持现在时间退款并且余额这笔是第一次退款， 所以生成退款流水PP_PAY(状态为新建， 类型为退款)

去渠道进行退款了， 根据退款的状态更新PP_PAY(可能为退款异常， 退款成功，无效（**本次肯定不会是， 因为是第一次退**）)

然后还要更新PP_pAY_REFUND_TASK, (可能为退款异常， 退款成功，无效（**本次肯定不会是， 因为是第一次退**）)

然后看看是不是这笔退款请求所有的退款任务都处理成功了。 这一次肯定没有处理完（**不论余额退没退成功， 因为微信一定没退成功**），没处理完就结束了

看看这笔退款金额大不大， 大了就发个短信，不大的话就不用了







# 那现在剩下什么问题了？

PP_PAY_REFUND_REQUEST这笔退款是不是还没处理完？ 状态为处理中

余额对应的退款流水如果退款成功了那就是余额对应的PP_PAY状态为成功了，否则为处理异常了

微信对应的退款流水状态肯定还是新建状态



30分钟一次的定时退款会把余额（如果余额实时退款失败）和微信的都扫描到

更新这两笔的退款任务PP_PAY_TASK状态为处理中

此时无需再次退款拆分了， 因为已经拆分过得。

余额是第二次退款不会再插入PP_PAY退款记录，而微信是第一次退会插入PP_PAY退款记录



如果此时余额和微信都退成功， 微信到账5元，余额到账2元

更新余额和微信的PP_PAY以及PP_pAY_TASK状态为成功

此时PP_PAY_REFUND_REQUEST退款请求对应的两笔退款都处理成功了， 将状态从处理中更新为成功

发送通知勾兑， 通知商户